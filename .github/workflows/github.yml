name: CI/CD Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” GitHub Secrets ë””ë²„ê¹…
        run: |
          echo "âœ… EC2_HOST í™•ì¸:"
          echo "${{ secrets.EC2_HOST }}"

          echo "âœ… EC2_USER í™•ì¸:"
          echo "${{ secrets.EC2_USER }}"

          echo "âœ… EC2_KEY ê¸¸ì´ (ì¤„ ìˆ˜):"
          echo "${{ secrets.EC2_KEY }}" | wc -l

          echo "âœ… EC2_KEY ì²« ì¤„:"
          echo "${{ secrets.EC2_KEY }}" | head -n 1

      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "âœ… í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™"
            cd /home/mine/service/Legendary-Statistics

            echo "âœ… Git ìµœì‹  ì½”ë“œ pull"
            git reset --hard HEAD
            git pull origin main

            echo "âœ… ë°±ì—”ë“œ ë¹Œë“œ ì‹œì‘"
            cd backend
            chmod +x gradlew
            ./gradlew build -x test -Pspring.profiles.active=prod

            echo "âœ… ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ"
            docker build -t mine0702/legendary-backend .

            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ"
            cd ../frontend
            docker build -t mine0702/legendary-frontend .

            echo "âœ… docker-compose ì¬ì‹œì‘"
            cd /home/mine/service
            echo "âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            docker rm -f backend frontend || true

            echo "âœ… docker-compose ì¢…ë£Œ ë° ì •ë¦¬"
            docker-compose down --remove-orphans

            echo "âœ… docker-compose ì¬ì‹œì‘"
            docker-compose up -d
