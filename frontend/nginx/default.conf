# http 컨텍스트 지시어 (server 밖)
map $http_user_agent $use_prerender {
  default 0;
  "~*AdsBot-Google" 1;
  "~*Googlebot"     1;
  "~*bingbot"       1;
  "~*DuckDuckBot"   1;
}

upstream prerender {
  server rendertron:3000;
}

server{
    listen 3000;

    location /uploads/ {
        alias /uploads/;
        autoindex on;
    }

    location / {
        # 봇에게만 프리렌더 스냅샷 제공
        if ($use_prerender) {
          # 원본 프로토콜 유지
          set $proto $scheme;
          if ($http_x_forwarded_proto) { set $proto $http_x_forwarded_proto; }

          set $snap "http://prerender/render/${proto}://$host$request_uri";
          proxy_set_header X-Forwarded-Proto $proto;
          proxy_set_header X-Forwarded-Host  $host;
          proxy_pass $snap;
          break;
        }

        root /usr/share/nginx/html;

        index index.html index.htm;

        try_files $uri $uri/ /index.html;
    }

    location /api/ {

        proxy_pass http://backend:8080;

        proxy_set_header Host $host;

        proxy_set_header X-Real-IP $remote_addr;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
