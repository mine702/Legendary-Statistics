# ---- server 밖(http 컨텍스트) ----
# 봇 식별
map $http_user_agent $is_bot {
  default 0;
  "~*AdsBot-Google|Googlebot|bingbot|DuckDuckBot" 1;
}
# 봇이면 @prerender, 아니면 /index.html 로 폴백
map $is_bot $fallback {
  1 @prerender;
  0 /index.html;
}

# Rendertron 업스트림 (docker-compose 서비스명)
upstream prerender { server rendertron:3000; }

# ---- 서버 블록 ----
server {
  listen 3000;

  location /uploads/ {
    alias /uploads/;
    autoindex on;
  }

  # 사람/봇 공용 진입점
  location / {
    root /usr/share/nginx/html;
    index index.html index.htm;
    # 파일이나 디렉토리 없으면 $fallback으로 이동 (@prerender 또는 /index.html)
    try_files $uri $uri/ $fallback;
  }

  # 봇 전용 프리렌더 처리
  location @prerender {
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_pass http://prerender/render/$scheme://$host$request_uri;
  }

  location /api/ {
    proxy_pass http://backend:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
