server {
  listen 3000;

  # 봇 감지 플래그 (server 스코프에서 처리)
  set $use_prerender 0;
  if ($http_user_agent ~* (AdsBot-Google|Googlebot|bingbot|DuckDuckBot)) { set $use_prerender 1; }

  location /uploads/ {
    alias /uploads/;
    autoindex on;
  }

  location / {
    # 봇이면 Rendertron 스냅샷 반환
    if ($use_prerender) {
      set $proto $scheme;
      if ($http_x_forwarded_proto) { set $proto $http_x_forwarded_proto; }
      proxy_set_header X-Forwarded-Proto $proto;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_pass http://rendertron:3000/render/$proto://$host$request_uri;
      break;
    }

    # 사람은 SPA 그대로
    root /usr/share/nginx/html;

    index index.html index.htm;

    try_files $uri $uri/ /index.html;
  }

  location /api/ {
    proxy_pass http://backend:8080;

    proxy_set_header Host $host;

    proxy_set_header X-Real-IP $remote_addr;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
