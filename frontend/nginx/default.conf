# --- http 컨텍스트 지시어(파일 맨 위, server 밖) ---
map $http_user_agent $use_prerender {
  default 0;
  "~*AdsBot-Google" 1;
  "~*Googlebot"     1;
  "~*bingbot"       1;
  "~*DuckDuckBot"   1;
}

upstream prerender { server rendertron:3000; }

# --- 가상서버 ---
server {
  listen 3000;

  location /uploads/ {
    alias /uploads/;
    autoindex on;
  }

  location / {
    # 봇이면 Rendertron 스냅샷
    if ($use_prerender) {
      set $proto $scheme;
      if ($http_x_forwarded_proto) { set $proto $http_x_forwarded_proto; }
      proxy_set_header X-Forwarded-Proto $proto;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_pass http://prerender/render/${proto}://$host$request_uri;
      break;
    }

    # 사람은 SPA
    root /usr/share/nginx/html;
    index index.html index.htm;
    try_files $uri $uri/ /index.html;
  }

  location /api/ {
    proxy_pass http://backend:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
