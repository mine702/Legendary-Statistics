# -------- http 컨텍스트 밖 --------
# 크롤러 식별(InspectionTool 등 포함)
map $http_user_agent $is_bot {
  default 0;
  ~*(googlebot|google-inspectiontool|googleother|adsbot-google|mediapartners-google|bingbot|duckduckbot|facebookexternalhit|twitterbot|linkedinbot|slackbot|whatsapp|telegrambot|discordbot|applebot) 1;
}

# 봇이면 프리렌더, 아니면 SPA index.html
map $is_bot $fallback {
  1 @prerender;
  0 /index.html;
}

# Rendertron 업스트림 (docker-compose 서비스명)
upstream prerender { server rendertron:3000; }

# -------- 서버 블록 --------
server {
  listen 3000;

  # 정적 업로드
  location /uploads/ {
    alias /uploads/;
    autoindex on;
  }

  location = /robots.txt {
    root /usr/share/nginx/html;
    try_files /robots.txt =404;
  }

  location = /sitemap.xml {
    root /usr/share/nginx/html;
    try_files /sitemap.xml =404;
  }

  # 임시
  location = /home {
    return 301 https://$host/;
  }

  # 공용 진입점: 파일/디렉터리 없으면 $fallback
  location / {
    root  /usr/share/nginx/html;
    index index.html index.htm;
    try_files $uri $uri/ $fallback;
    add_header Vary "User-Agent";
  }

  # 프리렌더 처리
  location @prerender {
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_pass http://prerender/render/$scheme://$host$request_uri;
    add_header Vary "User-Agent";
  }

  # API 프록시
  location /api/ {
    proxy_pass http://backend:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
